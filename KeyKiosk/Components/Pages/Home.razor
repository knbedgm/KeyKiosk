@page "/home"
@using KeyKiosk.Data

<PageTitle>Home</PageTitle>

<h3>Home</h3>

<label>Start Date: </label>
<input type="date" @bind="StartDate" />

<label>End Date: </label>
<input type="date" @bind="EndDate"/>

<button @onclick="() => GenerateEfficiencyReport()">Preview Efficiency Report</button>

@code {

    public DateTimeOffset StartDate { get; set; } = new DateTimeOffset(DateTime.Now);
    public DateTimeOffset EndDate { get; set; } = new DateTimeOffset(DateTime.Now);
    [Inject] private WorkOrderService WorkOrderService { get; set; }
    [Inject] private WorkOrderTaskTemplateService TemplateService { get; set; }
    [Inject] private PDFService PDFService { get; set; } = default!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    public async void GenerateEfficiencyReport()
    {
        List<WorkOrder> workOrders = await WorkOrderService.GetWorkOrderByDatePeriod(StartDate, EndDate);
        List<WorkOrderTaskTemplate> templates = TemplateService.GetAllTaskTemplates();

        await PreviewEfficiencyReportAsync(workOrders, templates, StartDate, EndDate);
	}

	private async Task PreviewEfficiencyReportAsync(List<WorkOrder> workOrders, List<WorkOrderTaskTemplate> templates, DateTimeOffset startDate, DateTimeOffset endDate)
    {
        var pdfBytes = PDFService.GenerateEfficiencyReport(workOrders, templates, startDate, endDate);

        var base64 = Convert.ToBase64String(pdfBytes);

        // Inject JS function directly here
        var js = @"
            window.openPdfPreview = (base64) => {
                const pdfDataUri = ""data:application/pdf;base64,"" + base64;
                const win = window.open();
                win.document.write(
                    ""<iframe src='"" + pdfDataUri + ""' "" +
                    ""frameborder='0' style='width:100%;height:100%;'></iframe>""
                );
            };
        ";
        await JSRuntime.InvokeVoidAsync("eval", js);

        // Call JS function to open in new tab
        await JSRuntime.InvokeVoidAsync("openPdfPreview", base64);
    }
}
