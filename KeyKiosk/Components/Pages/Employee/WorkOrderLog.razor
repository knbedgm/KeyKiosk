@page "/employee/admin/workorderlogs"
@using KeyKiosk.Data
@using KeyKiosk.Services
@using System.Text
@layout Layout.MainLayout
@inject WorkOrderLogService LogService
@inject WorkOrderAuditService AuditService
@inject IJSRuntime JS

<PageTitle>Work Order Logs</PageTitle>
<h2 class="mb-4">Work Order Logs</h2>

<!-- Filter Form -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-2">
                <input class="form-control" placeholder="Username" @bind="username" />
            </div>
            <div class="col-md-2">
                <input class="form-control" placeholder="WorkOrder ID" type="number" @bind="workOrderId" />
            </div>
            <div class="col-md-2">
                <input class="form-control" placeholder="Vehicle Plate" @bind="vehiclePlate" />
            </div>
            <div class="col-md-2">
                <select class="form-select" @bind="eventType">
                    <option value="">-- Event Type --</option>
                    @foreach (var type in Enum.GetValues<WorkOrderLogEvent.WorkOrderLogEventType>())
                    {
                        <option value="@type">@type</option>
                    }
                </select>
            </div>
            <div class="col-md-2 d-flex gap-2">
                <button class="btn btn-primary flex-fill" @onclick="LoadLogs">Search</button>
                <button class="btn btn-outline-secondary flex-fill" @onclick="ExportCsv">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Demo Button -->
<div class="mb-3">
    <button class="btn btn-success" @onclick="CreateTestWorkOrder">Create Test Work Order (demo)</button>
</div>

<!-- Results -->
@if (logs == null)
{
    <p><em>Loading...</em></p>
}
else if (!logs.Any())
{
    <div class="alert alert-warning">No log events found.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th class="text-center">ID</th>
                    <th class="text-center">Date</th>
                    <th class="text-center">User</th>
                    <th class="text-center">WorkOrder</th>
                    <th class="text-center">Customer</th>
                    <th class="text-center">Plate</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Start</th>
                    <th class="text-center">End</th>
                    <th class="text-center">Event</th>
                    <th class="text-center">Details</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in logs)
                {
                    <tr>
                        <td class="px-3">@log.ID</td>
                        <td class="px-3">@log.DateTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td class="px-3">@log.UserName</td>
                        <td class="px-3">@log.workOrder.Id</td>
                        <td class="px-3">@log.workOrder.CustomerName</td>
                        <td class="px-3">@log.workOrder.VehiclePlate</td>
                        <td class="px-3">@log.workOrder.Status</td>
                        <td class="px-3">@(log.workOrder.StartDate?.ToLocalTime().ToString("g") ?? "-")</td>
                        <td class="px-3">@(log.workOrder.EndDate?.ToLocalTime().ToString("g") ?? "-")</td>
                        <td class="px-3">
                            <span class="badge bg-info text-dark">
                                @(
                                    log.EventType switch
                                    {
                                        WorkOrderLogEvent.WorkOrderLogEventType.Created => "Work Order Created",
                                        WorkOrderLogEvent.WorkOrderLogEventType.StatusChanged => "Status Updated",
                                        WorkOrderLogEvent.WorkOrderLogEventType.DetailsChanged => "Details Updated",
                                        WorkOrderLogEvent.WorkOrderLogEventType.TaskAdded => "Task Added",
                                        WorkOrderLogEvent.WorkOrderLogEventType.TaskRemoved => "Task Removed",
                                        WorkOrderLogEvent.WorkOrderLogEventType.TaskStatusChanged => "Task Status Updated",
                                        WorkOrderLogEvent.WorkOrderLogEventType.TaskDetailsChanged => "Task Details Updated",
                                        _ => log.EventType.ToString()
                                    }
                                )
                            </span>
                        </td>
                        <td class="px-3">
                            @switch (log)
                            {
                                case WorkOrderLogEvent.DetailsChangedEvent detailsEvent:
                                    <details>
                                        <summary>Details changed</summary>
                                        <div>Customer: @detailsEvent.CustomerName</div>
                                        <div>Plate: @detailsEvent.VehiclePlate</div>
                                        <div>@detailsEvent.Details</div>
                                    </details>
                                    break;

                                case WorkOrderLogEvent.TaskAddedEvent taskAdded:
                                    <span>Task added: <strong>@taskAdded.Task?.Title</strong></span>
                                    break;

                                case WorkOrderLogEvent.TaskRemovedEvent taskRemoved:
                                    <span>Task removed: <strong>@taskRemoved.Task?.Title</strong></span>
                                    break;

                                case WorkOrderLogEvent.TaskDetailsChangedEvent taskDetails:
                                    <details>
                                        <summary>Task details changed</summary>
                                        <div>Task: @taskDetails.Task?.Title</div>
                                        <div>@taskDetails.Details</div>
                                        <div>Cost: @(taskDetails.CostCents / 100.0m).ToString("C")</div>
                                    </details>
                                    break;

                                case WorkOrderLogEvent.CreateEvent:
                                    <span class="text-success">Work order created</span>
                                    break;

                                case WorkOrderLogEvent.StatusChangedEvent statusEvent:
                                    <span>Status → <strong>@statusEvent.Status</strong></span>
                                    break;

                                default:
                                    <span>-</span>
                                    break;
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<WorkOrderLogEvent>? logs;

    private string? username;
    private int? workOrderId;
    private string? status;
    private string? vehiclePlate;
    private string? search;
    private WorkOrderLogEvent.WorkOrderLogEventType? eventType;

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        logs = await LogService.GetFilteredLogsAsync(username, workOrderId, status, vehiclePlate, search, eventType);
    }

    private async Task ExportCsv()
    {
        var csv = await LogService.ExportLogsToCsvAsync(username, workOrderId, status, vehiclePlate, search, eventType);
        var bytes = Encoding.UTF8.GetBytes(csv);
        var fileName = $"WorkOrderLogs_{DateTime.Now:yyyyMMddHHmmss}.csv";

        using var stream = new MemoryStream(bytes);
        using var streamRef = new DotNetStreamReference(stream: stream);

        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }

    // Demo handler: creates a dummy work order and logs it
    private async Task CreateTestWorkOrder()
    {
        var newWorkOrder = new WorkOrder
        {
            CustomerName = "Goofy Duck",
            VehiclePlate = "GGDD423",
            Details = "Headlight replacement",
            Status = WorkOrderStatusType.Created,
            StartDate = DateTimeOffset.Now,
            EndDate = DateTimeOffset.Now.AddHours(2),
            Tasks = new List<WorkOrderTask>(),
            Parts = new List<WorkOrderPart>()
        };

        await AuditService.AddWorkOrderAsync(newWorkOrder);
        await LoadLogs();
    }
}
