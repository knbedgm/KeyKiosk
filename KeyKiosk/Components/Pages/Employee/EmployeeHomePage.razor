@page "/employee/home"
@rendermode InteractiveServer
@layout Layout.MainLayout

@using KeyKiosk.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db

<h3>Employee Home - Work Orders Management</h3>

<button class="btn btn-primary mb-3" @onclick="NewWorkOrder">New Work Order</button>

@if (workOrders == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Vehicle Plate</th>
                <th>Status</th>
                <th>Start</th>
                <th>End</th>
                <th>Total Cost</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var wo in workOrders)
            {
                <tr>
                    <td>@wo.Id</td>
                    <td>@wo.CustomerName</td>
                    <td>@wo.VehiclePlate</td>
                    <td>@wo.Status</td>
                    <td>@wo.StartDate?.ToString("yyyy-MM-dd")</td>
                    <td>@wo.EndDate?.ToString("yyyy-MM-dd")</td>
                    <td>@($"{wo.TotalCostCents / 100.0:C}")</td>
                    <td>
                        <button class="btn btn-sm btn-secondary me-2" @onclick="() => EditWorkOrder(wo.Id)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteWorkOrder(wo.Id)">Delete</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => GeneratePdfAsync(wo)">DownloadPDF</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => PreviewPdfAsync(wo)">PreviewPDF</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (editWorkOrder != null)
{
    <EditForm Model="editWorkOrder" OnValidSubmit="SaveWorkOrder">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-2">
            <label>Customer Name</label>
            <InputText class="form-control" @bind-Value="editWorkOrder.CustomerName" />
        </div>

        <div class="mb-2">
            <label>Vehicle Plate</label>
            <InputText class="form-control" @bind-Value="editWorkOrder.VehiclePlate" />
        </div>

        <div class="mb-2">
            <label>Status</label>
            <InputSelect class="form-control" @bind-Value="editWorkOrder.Status">
                @foreach (var s in Enum.GetValues<WorkOrderStatusType>())
                {
                    <option value="@s">@s</option>
                }
            </InputSelect>
        </div>

        <div class="mb-2">
            <label>Details</label>
            <InputTextArea class="form-control" @bind-Value="editWorkOrder.Details" />
        </div>

        <div class="mb-2">
            <label>Start Date</label>
            <InputDate class="form-control" @bind-Value="editWorkOrder.StartDate" />
        </div>

        <div class="mb-2">
            <label>End Date</label>
            <InputDate class="form-control" @bind-Value="editWorkOrder.EndDate" />
        </div>

        <button type="submit" class="btn btn-success">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
    </EditForm>
}